# 🚀 Staging Deployment Guide with Kamal 2

## 📋 Overview

This guide covers the complete process of deploying a Spree Rails 8 application to a staging server using Kamal 2. The staging server is already configured with Ansible (system, security, Docker, Nginx, SSL).

## 🏗️ Architecture

```
Internet → Cloudflare → Nginx (SSL) → Docker Container (Rails App)
                                    ↓
                              SQLite Database + Solid Cache
```

- **Cloudflare**: DNS, SSL termination, proxy
- **Nginx**: Reverse proxy, SSL termination, static assets
- **Docker**: Application containerization
- **SQLite**: Staging database (simpler than PostgreSQL)
- **Solid Cache**: File-based caching system (SQLite backend)

## 🔑 Credentials & Secrets Management

### 1. Rails 8 Credentials System

Rails 8 uses the modern **Credentials API** instead of the old `master.key` system.

#### Current Credentials Files:
- `config/credentials/staging.key` - **ENCRYPTION KEY** (NEVER commit to git!)
- `config/credentials/staging.yml.enc` - **ENCRYPTED CREDENTIALS** (safe to commit)

#### Important Security Notes:
- **NEVER commit** `config/credentials/staging.key` to git
- The `.key` file is automatically added to `.gitignore`
- Store the key value in a password manager for your team

### 2. Creating Staging Credentials

**CRITICAL STEP:** Generate staging credentials first:

```bash
# Create staging credentials with auto-generated secret_key_base
EDITOR="cursor --wait" rails credentials:edit --environment staging
```

This will:
- Create `config/credentials/staging.key` (encryption key)
- Create `config/credentials/staging.yml.enc` (encrypted credentials)
- Auto-generate `secret_key_base`

### 3. Staging Credentials Content

The staging credentials file should contain:
```yaml
# config/credentials/staging.yml.enc (decrypted view)
secret_key_base: [auto-generated by Rails]
docker_hub:
  username: viandrianoff
  password: your_docker_hub_password_or_token
database_url: "sqlite3:/rails/storage/databases/staging.sqlite3"
# Add other staging-specific secrets here
```

### 4. Testing Credentials (Without Database)

```bash
# Test if credentials can be decrypted (without loading Rails app)
RAILS_ENV=staging rails credentials:show --environment staging

# Verify staging.key exists
cat config/credentials/staging.key
```

**Note:** Don't use `rails runner` for testing credentials as it requires database connection.

## 💾 Solid Cache Configuration

### 1. Database Configuration

Solid Cache is already properly configured in `config/database.yml`:

```yaml
staging:
  primary:
    adapter: sqlite3
    database: storage/databases/staging.sqlite3
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    timeout: 5000
  solid_queue:
    adapter: sqlite3
    database: storage/databases/solid_queue_staging.sqlite3
  solid_cable:
    adapter: sqlite3
    database: storage/databases/solid_cable_staging.sqlite3
  solid_cache:
    adapter: sqlite3
    database: storage/databases/solid_cache_staging.sqlite3
```

### 2. Cache Store Configuration

Already configured in `config/environments/staging.rb`:
```ruby
config.cache_store = :solid_cache_store
```

### 3. Cache Configuration File

**REQUIRED:** Add staging section to `config/cache.yml`:

```yaml
default: &default
  store_options:
    max_size: <%= 256.megabytes %>
    namespace: <%= Rails.env %>

development:
  <<: *default

test:
  <<: *default

staging:
  database: solid_cache  # ← ADD THIS SECTION
  <<: *default

production:
  database: cache
  <<: *default
```

## 🐳 Docker Configuration (UPDATED - SIMPLIFIED)

### 1. Dockerfile Analysis

**NEW APPROACH:** Dockerfile now focuses on runtime setup, assets compiled after deployment:

- Multi-stage build for optimization
- Ruby 3.4.1 slim image
- **Node.js 20.x for JavaScript runtime** (for post-deploy asset compilation)
- **NPM dependencies installation** (for Vite and other tools)
- **NO asset precompilation during build** (moved to post-deploy)
- Non-root user (rails:1000)
- Exposes port 80

### 2. Key Dockerfile Improvements

```dockerfile
# Added Node.js installation in base image
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl libjemalloc2 libvips postgresql-client && \
    # Install Node.js 20.x for JavaScript runtime
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install --no-install-recommends -y nodejs && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Added NPM dependencies installation
COPY package.json package-lock.json ./
RUN npm ci --only=production && npm cache clean --force

# NOTE: Assets will be compiled after deployment when symlinks are properly set up
# This avoids issues with missing Spree gem JavaScript files during Docker build
```

### 3. Why Assets Are NOT Compiled During Build

**Problem Solved:** Spree gem JavaScript files are not available during Docker build, causing errors like:
```
No such file or directory @ rb_sysopen - app/frontend/spree/gem/@rails--request.js.js
```

**Solution:** Assets are now compiled **after deployment** when:
1. Spree symlinks are properly created
2. All gem files are accessible
3. Database is available for Rails tasks

### 4. Image Naming Convention

For staging, use: `viandrianoff/spree-rails8-staging:latest`

## 📁 Kamal Configuration Files

### 1. Main Deploy Config: `config/deploy.staging.yml`

**Already configured correctly:**

```yaml
service: spree-rails8-staging
image: viandrianoff/spree-rails8-staging

servers:
  web:
    - 95.217.223.50
  job:
    hosts:
      - 95.217.223.50
    cmd: bin/jobs

# SSL handled by Nginx (Ansible)
proxy:
  ssl: false
  host: staging.andrianoff.online

# Docker Hub registry
registry:
  username: viandrianoff
  password:
    - KAMAL_REGISTRY_PASSWORD

# Environment variables
env:
  secret:
    - RAILS_MASTER_KEY
  clear:
    RAILS_ENV: staging
    DATABASE_URL: sqlite3:/rails/storage/databases/staging.sqlite3
    SOLID_QUEUE_IN_PUMA: true
    JOB_CONCURRENCY: 2
    WEB_CONCURRENCY: 2

# Persistent storage
volumes:
  - "spree_staging_storage:/rails/storage"
```

### 2. Secrets File: `.kamal/secrets`

**Already configured correctly:**

```bash
# Docker Hub credentials from Rails credentials
KAMAL_REGISTRY_PASSWORD=$(rails runner "puts Rails.application.credentials.docker_hub.password" -e staging)

# Rails 8 Staging credentials
RAILS_MASTER_KEY=$(cat config/credentials/staging.key)

# Additional secrets
VITE_API_URL=https://staging.andrianoff.online
DATABASE_URL=sqlite3:/rails/storage/databases/staging.sqlite3
SPREE_STORE_NAME="Staging Store"
SPREE_STORE_CODE=staging
```

## 🔄 Complete Deployment Workflow (UPDATED)

### Phase 1: Local Preparation (COMPLETED ✅)

#### 1.1 Create Staging Credentials (COMPLETED ✅)
```bash
# Generate staging credentials with secret_key_base
EDITOR="cursor --wait" rails credentials:edit --environment staging

# Add Docker Hub credentials in the opened editor:
# secret_key_base: [keep auto-generated]
# docker_hub:
#   username: viandrianoff
#   password: your_docker_hub_password_or_token
```

#### 1.2 Update Cache Configuration (COMPLETED ✅)
```bash
# Add staging section to config/cache.yml:
# staging:
#   database: solid_cache
#   <<: *default
```

#### 1.3 Build Docker Image (SIMPLIFIED - NO ASSETS)
```bash
# Build staging image locally (without asset compilation)
docker build -t viandrianoff/spree-rails8-staging:latest .

# This should now build successfully without JavaScript runtime errors
```

#### 1.4 Push to Registry
```bash
# Login to Docker Hub
docker login

# Push image
docker push viandrianoff/spree-rails8-staging:latest
```

### Phase 2: Server Deployment (UPDATED)

#### 2.1 Initial Deploy
```bash
# Deploy to staging
kamal deploy --config config/deploy.staging.yml
```

#### 2.2 Post-Deploy Setup (CRITICAL - NEW ORDER!)

**IMPORTANT:** Assets are now compiled AFTER deployment in the correct order:

```bash
# 1. Database setup
kamal app exec --config config/deploy.staging.yml "bin/rails db:create db:migrate"

# 2. Setup Spree symlinks FIRST (before assets)
kamal app exec --config config/deploy.staging.yml "bin/rails spree:setup_symlinks"

# 3. Compile assets AFTER symlinks are ready
kamal app exec --config config/deploy.staging.yml "bin/rails assets:precompile"

# 4. Vite setup
kamal app exec --config config/deploy.staging.yml "bin/rails vite:install"
kamal app exec --config config/deploy.staging.yml "bin/rails vite:build"

# 5. Spree store setup
kamal app exec --config config/deploy.staging.yml "bin/rails spree:install"

# 6. Load sample data (optional)
kamal app exec --config config/deploy.staging.yml "bin/rails spree:load_sample_data"
```

#### 2.3 Verify Deployment
```bash
# Check application status
kamal app status --config config/deploy.staging.yml

# View logs
kamal app logs --config config/deploy.staging.yml

# Test health endpoint
curl https://staging.andrianoff.online/up
```

## 🚀 Automation with Kamal Hooks (UPDATED)

### 1. Post-Deploy Automation

Create `.kamal/hooks/post-deploy.sh`:
```bash
#!/bin/bash
# .kamal/hooks/post-deploy.sh

echo "🚀 Running post-deploy setup..."

# Database setup
echo "📊 Setting up database..."
kamal app exec --config config/deploy.staging.yml "bin/rails db:create db:migrate"

# Spree symlinks setup (CRITICAL FIRST!)
echo "🔗 Setting up Spree symlinks..."
kamal app exec --config config/deploy.staging.yml "bin/rails spree:setup_symlinks"

# Asset compilation (AFTER symlinks are ready)
echo "⚡ Compiling assets..."
kamal app exec --config config/deploy.staging.yml "bin/rails assets:precompile"

# Vite setup
echo "⚡ Setting up Vite..."
kamal app exec --config config/deploy.staging.yml "bin/rails vite:install"
kamal app exec --config config/deploy.staging.yml "bin/rails vite:build"

# Spree setup
echo "🛍️ Setting up Spree..."
kamal app exec --config config/deploy.staging.yml "bin/rails spree:install"

# Load sample data (optional)
echo "📦 Loading sample data..."
kamal app exec --config config/deploy.staging.yml "bin/rails spree:load_sample_data"

echo "✅ Post-deploy setup completed!"
```

Make it executable:
```bash
chmod +x .kamal/hooks/post-deploy.sh
```

### 2. Why This Order Matters

1. **Database first** - Required for Rails tasks
2. **Symlinks second** - Makes Spree gem files accessible
3. **Assets third** - Now all JavaScript files are available
4. **Vite fourth** - Frontend build tools
5. **Spree setup** - Store configuration
6. **Sample data last** - Optional demo content

## 💾 Storage Persistence

### 1. Volume Configuration

Storage is configured as persistent volumes in `config/deploy.staging.yml`:

```yaml
volumes:
  - "spree_staging_storage:/rails/storage"
```

### 2. What Gets Persisted

- **SQLite Primary Database**: `/rails/storage/databases/staging.sqlite3`
- **Solid Queue Database**: `/rails/storage/databases/solid_queue_staging.sqlite3`
- **Solid Cable Database**: `/rails/storage/databases/solid_cable_staging.sqlite3`
- **Solid Cache Database**: `/rails/storage/databases/solid_cache_staging.sqlite3`
- **Active Storage Files**: `/rails/storage/active_storage/`
- **Compiled Assets**: `/rails/public/assets/` (compiled after deployment)
- **Vite Assets**: `/rails/public/vite/` (compiled after deployment)
- **Log Files**: `/rails/storage/logs/`
- **Temporary Files**: `/rails/storage/tmp/`

### 3. Backup Strategy

```bash
# Backup all databases
kamal app exec --config config/deploy.staging.yml "tar -czf /rails/storage/backups/databases_$(date +%Y%m%d_%H%M%S).tar.gz -C /rails/storage/databases ."

# Backup entire storage directory
kamal app exec --config config/deploy.staging.yml "tar -czf /rails/storage/backups/storage_$(date +%Y%m%d_%H%M%S).tar.gz -C /rails/storage ."
```

## 🛠️ Kamal Commands Reference

### Basic Commands
```bash
# Deploy
kamal deploy --config config/deploy.staging.yml

# Rollback
kamal rollback --config config/deploy.staging.yml

# Status
kamal app status --config config/deploy.staging.yml

# Logs
kamal app logs --config config/deploy.staging.yml
```

### Interactive Commands
```bash
# Rails console
kamal app exec --config config/deploy.staging.yml --interactive "bin/rails console"

# Shell access
kamal app exec --config config/deploy.staging.yml --interactive "bash"

# Database console
kamal app exec --config config/deploy.staging.yml --interactive "bin/rails dbconsole"
```

### Maintenance Commands
```bash
# Restart application
kamal app restart --config config/deploy.staging.yml

# Health check
kamal app healthcheck --config config/deploy.staging.yml

# Recompile assets (if needed)
kamal app exec --config config/deploy.staging.yml "bin/rails assets:precompile"

# View environment variables
kamal app exec --config config/deploy.staging.yml "printenv | grep RAILS"
```

## 🚨 Troubleshooting (UPDATED)

### Common Issues

#### 1. JavaScript Runtime Error (SOLVED ✅)
```bash
# Error: ExecJS::RuntimeUnavailable: Could not find a JavaScript runtime
# Solution: Node.js 20.x is now included in Dockerfile
# This error should no longer occur
```

#### 2. Missing Spree JavaScript Files (SOLVED ✅)
```bash
# Error: No such file or directory @ rb_sysopen - app/frontend/spree/gem/@rails--request.js.js
# Solution: Assets are now compiled AFTER deployment when symlinks are ready
# This error should no longer occur with the new deployment order
```

#### 3. Credentials Error
```bash
# Error: Missing credentials or secret_key_base
# Solution: Ensure staging credentials are created
EDITOR="cursor --wait" rails credentials:edit --environment staging

# Verify credentials
RAILS_ENV=staging rails credentials:show --environment staging
```

#### 4. Database Connection Error (Local Testing)
```bash
# Error: Could not find table 'spree_addresses'
# This is NORMAL when testing locally - staging database doesn't exist locally
# Solution: Don't test with rails runner locally, deploy to server first
```

#### 5. Docker Hub Authentication
```bash
# Error: Authentication failed
# Solution: Verify Docker Hub credentials in Rails credentials
rails credentials:show --environment staging
```

#### 6. Solid Cache Configuration
```bash
# Error: Cache database not found
# Solution: Ensure staging section exists in config/cache.yml
# staging:
#   database: solid_cache
#   <<: *default
```

#### 7. Asset Compilation Issues (Post-Deploy)
```bash
# Error: Assets not found after deployment
# Solution: Run asset compilation manually
kamal app exec --config config/deploy.staging.yml "bin/rails assets:precompile"

# Check if symlinks were created properly
kamal app exec --config config/deploy.staging.yml "ls -la app/frontend/spree/gem/"
```

#### 8. Symlink Creation Issues
```bash
# Error: Symlinks not created properly
# Solution: Run symlink setup manually
kamal app exec --config config/deploy.staging.yml "bin/rails spree:setup_symlinks"

# Verify Spree gem path
kamal app exec --config config/deploy.staging.yml "bundle show spree"
```

## 📊 Monitoring & Maintenance

### 1. Health Checks
- Endpoint: `/up`
- Kamal automatically monitors this
- Configured in deploy.staging.yml

### 2. Log Management
```bash
# View application logs
kamal app logs --config config/deploy.staging.yml

# View Nginx logs (on server)
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 3. Cache Monitoring
```bash
# Check Solid Cache database size
kamal app exec --config config/deploy.staging.yml "ls -lh /rails/storage/databases/solid_cache_staging.sqlite3"

# Clear cache if needed
kamal app exec --config config/deploy.staging.yml "bin/rails cache:clear"
```

### 4. Asset Management
```bash
# Check compiled assets
kamal app exec --config config/deploy.staging.yml "ls -la public/assets/"
kamal app exec --config config/deploy.staging.yml "ls -la public/vite/"

# Recompile assets if needed
kamal app exec --config config/deploy.staging.yml "bin/rails assets:precompile"
kamal app exec --config config/deploy.staging.yml "bin/rails vite:build"
```

## 🔄 CI/CD Integration

### GitHub Actions Workflow

```yaml
# .github/workflows/deploy-staging.yml
name: Deploy to Staging

on:
  push:
    branches: [ staging ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and push Docker image
        run: |
          docker build -t viandrianoff/spree-rails8-staging:${{ github.sha }} .
          docker push viandrianoff/spree-rails8-staging:${{ github.sha }}
      
      - name: Deploy to staging
        run: |
          kamal deploy --config config/deploy.staging.yml
        env:
          RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
          KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
```

## 📝 Updated Checklist Before Deployment

### Pre-Deployment (COMPLETED ✅)
- [x] Staging environment configured (`config/environments/staging.rb`)
- [x] Kamal configuration ready (`config/deploy.staging.yml`)
- [x] Secrets file configured (`.kamal/secrets`)
- [x] **Staging credentials created** ✅
- [x] **Docker Hub credentials added to Rails credentials** ✅
- [x] **Staging section added to config/cache.yml** ✅
- [x] **Dockerfile optimized (no asset compilation during build)** ✅
- [x] **Post-deploy hook created** ✅
- [ ] Docker image built and pushed
- [ ] Server accessible via SSH
- [ ] Domain DNS configured (staging.andrianoff.online)

### Deployment
- [ ] Run `docker build -t viandrianoff/spree-rails8-staging:latest .`
- [ ] Run `docker push viandrianoff/spree-rails8-staging:latest`
- [ ] Run `kamal deploy --config config/deploy.staging.yml`
- [ ] Verify application starts successfully
- [ ] Check database connectivity
- [ ] Verify SSL certificate
- [ ] Test application functionality

### Post-Deployment (Automated via Hook)
- [ ] Database migrations completed
- [ ] Spree symlinks created
- [ ] Assets compiled successfully
- [ ] Vite setup completed
- [ ] Spree store configured
- [ ] Health check endpoint working (`/up`)
- [ ] Admin interface accessible
- [ ] Solid Cache working

## 🎯 Immediate Next Steps (READY!)

### Step 1: Build and Deploy
```bash
# 1. Build simplified Docker image (no assets, faster build)
docker build -t viandrianoff/spree-rails8-staging:latest .

# 2. Push to Docker Hub
docker push viandrianoff/spree-rails8-staging:latest

# 3. Deploy to staging (assets will compile on server)
kamal deploy --config config/deploy.staging.yml
```

### Step 2: Verify
```bash
# Check deployment status
kamal app status --config config/deploy.staging.yml

# Test application
curl https://staging.andrianoff.online/up

# Check logs for any issues
kamal app logs --config config/deploy.staging.yml
```

## 📚 Additional Resources

- [Kamal Documentation](https://kamal-deploy.org/)
- [Rails 8 Credentials Guide](https://guides.rubyonrails.org/security.html#custom-credentials)
- [Solid Cache Documentation](https://github.com/rails/solid_cache)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [Node.js in Docker](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)
- [Rails Asset Pipeline](https://guides.rubyonrails.org/asset_pipeline.html)

## ✅ Configuration Status (FINAL)

- ✅ **Solid Cache**: Properly configured with SQLite backend
- ✅ **Kamal Configuration**: Ready for deployment
- ✅ **Docker Configuration**: Optimized for runtime (no build-time assets)
- ✅ **Environment Configuration**: Staging environment set up
- ✅ **Credentials**: Staging credentials created with Docker Hub info
- ✅ **Cache Config**: Staging section added to cache.yml
- ✅ **JavaScript Runtime**: Node.js 20.x included in Dockerfile
- ✅ **Asset Strategy**: Post-deploy compilation (avoids Spree gem issues)
- ✅ **Post-Deploy Hook**: Automated setup in correct order

**Your deployment setup is now 100% ready and optimized!** 🚀

The new approach eliminates JavaScript runtime and Spree symlink issues by compiling assets after deployment when all dependencies are properly available.
